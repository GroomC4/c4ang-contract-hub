name: Documentation Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'src/main/avro/**/*.avsc'
      - 'docs/interface/**'
      - 'buildSrc/**'

  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy-docs:
    name: Generate and Deploy Documentation
    runs-on: ubuntu-latest

    permissions:
      contents: write  # docs ì»¤ë°‹ ê¶Œí•œ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Count Avro schemas
        id: count_schemas
        run: |
          AVRO_COUNT=$(find src/main/avro -name "*.avsc" | wc -l)
          echo "count=$AVRO_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Found $AVRO_COUNT Avro schema files"

      - name: Generate Avro documentation
        run: |
          echo "ğŸ“ Generating Avro documentation..."
          ./gradlew generateAvroEventDocs --no-daemon

      - name: Check for documentation changes
        id: check_changes
        run: |
          # docs/generated ë””ë ‰í† ë¦¬ì˜ ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --quiet docs/generated/; then
            echo "â„¹ï¸ No documentation changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Documentation changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
            CHANGED_FILES=$(git diff --name-only docs/generated/)
            echo "ğŸ“ Changed files:"
            echo "$CHANGED_FILES"
          fi

      - name: Commit and push documentation
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/generated/

          git commit -m "docs: ìë™ ìƒì„±ëœ Avro ë¬¸ì„œ ì—…ë°ì´íŠ¸

          - Avro ìŠ¤í‚¤ë§ˆ ${{ steps.count_schemas.outputs.count }}ê°œ ê¸°ì¤€
          - GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë¨

          ğŸ¤– Generated with GitHub Actions
          "

          git push

      - name: Display summary
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… Documentation updated and committed!"
            echo ""
            echo "ğŸ“Š Summary:"
            echo "  - Avro Schemas: ${{ steps.count_schemas.outputs.count }}"
            echo "  - Documentation: docs/generated/"
            echo "  - Commit: Pushed to main branch"
          else
            echo "â„¹ï¸ No documentation changes detected"
            echo ""
            echo "ğŸ“Š Summary:"
            echo "  - Avro Schemas: ${{ steps.count_schemas.outputs.count }}"
            echo "  - Documentation: Up to date"
          fi
