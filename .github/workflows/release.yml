name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest

    permissions:
      contents: write  # GitHub Release 생성 권한
      packages: write  # GitHub Packages 배포 권한

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT

      - name: Count Avro schemas
        id: count_schemas
        run: |
          AVRO_COUNT=$(find src/main/avro -name "*.avsc" | wc -l)
          echo "count=$AVRO_COUNT" >> $GITHUB_OUTPUT

      - name: Generate Avro Java classes
        run: ./gradlew generateAvroJava --no-daemon

      - name: Build project
        run: ./gradlew build --no-daemon

      - name: Generate Avro documentation
        run: ./gradlew generateAvroEventDocs --no-daemon

      - name: Package artifacts
        run: ./gradlew assemble --no-daemon

      - name: Publish to GitHub Packages
        run: ./gradlew publish --no-daemon
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GROOM_GITHUB_ACTION_TOKEN }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}

      - name: Get generated class count
        id: count_classes
        run: |
          JAVA_COUNT=$(find build/generated-main-avro-java -name "*.java" | wc -l)
          echo "count=$JAVA_COUNT" >> $GITHUB_OUTPUT

      - name: Extract schema changes
        id: schema_changes
        run: |
          echo "🔍 Extracting schema changes since last release..."

          # 이전 태그 찾기
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ℹ️ No previous tag found. This is the first release."
            echo "has_previous=false" >> $GITHUB_OUTPUT
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo "ℹ️ 첫 번째 릴리스입니다." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "📌 Comparing with previous tag: $PREVIOUS_TAG"
          echo "has_previous=true" >> $GITHUB_OUTPUT
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

          # 변경된 스키마 파일 찾기
          CHANGED_SCHEMAS=$(git diff --name-status $PREVIOUS_TAG...HEAD -- 'src/main/avro/**/*.avsc' | sort)

          if [ -z "$CHANGED_SCHEMAS" ]; then
            echo "ℹ️ No schema changes in this release"
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo "ℹ️ 스키마 변경사항이 없습니다." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 변경 타입별로 분류
          ADDED=$(echo "$CHANGED_SCHEMAS" | grep "^A" | sed 's/^A\t//' || true)
          MODIFIED=$(echo "$CHANGED_SCHEMAS" | grep "^M" | sed 's/^M\t//' || true)
          DELETED=$(echo "$CHANGED_SCHEMAS" | grep "^D" | sed 's/^D\t//' || true)

          # Breaking Change 체크
          BREAKING_FOUND=false
          BREAKING_DETAILS=""

          for schema in $(echo "$CHANGED_SCHEMAS" | grep "^M" | sed 's/^M\t//' || true); do
            if git diff $PREVIOUS_TAG...HEAD -- "$schema" | grep -E '^\-.*"name".*:|^\-.*"type".*:' > /dev/null; then
              BREAKING_FOUND=true
              BREAKING_DETAILS="${BREAKING_DETAILS}\n- \`${schema}\` (필드 삭제 또는 타입 변경)"
            fi
          done

          # 변경사항 요약 생성
          CHANGES_SUMMARY=""

          if [ -n "$ADDED" ]; then
            CHANGES_SUMMARY="${CHANGES_SUMMARY}\n#### ✨ 새로운 스키마\n"
            for file in $ADDED; do
              CHANGES_SUMMARY="${CHANGES_SUMMARY}\n- \`${file}\`"
            done
          fi

          if [ -n "$MODIFIED" ]; then
            CHANGES_SUMMARY="${CHANGES_SUMMARY}\n\n#### 🔄 수정된 스키마\n"
            for file in $MODIFIED; do
              CHANGES_SUMMARY="${CHANGES_SUMMARY}\n- \`${file}\`"
            done
          fi

          if [ -n "$DELETED" ]; then
            CHANGES_SUMMARY="${CHANGES_SUMMARY}\n\n#### ❌ 삭제된 스키마\n"
            for file in $DELETED; do
              CHANGES_SUMMARY="${CHANGES_SUMMARY}\n- \`${file}\`"
            done
          fi

          if [ "$BREAKING_FOUND" = true ]; then
            CHANGES_SUMMARY="${CHANGES_SUMMARY}\n\n#### ⚠️ Breaking Changes\n"
            CHANGES_SUMMARY="${CHANGES_SUMMARY}${BREAKING_DETAILS}"
            CHANGES_SUMMARY="${CHANGES_SUMMARY}\n\n**주의**: 이 릴리스는 호환성이 깨지는 변경을 포함합니다. Consumer 서비스 업데이트가 필요할 수 있습니다."
          fi

          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGES_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "breaking_found=$BREAKING_FOUND" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ steps.version.outputs.version }}
          path: |
            build/libs/*.jar
            docs/generated/*.md
          retention-days: 90

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## 📦 C4ang Contract Hub ${{ steps.version.outputs.tag }}

          이벤트 기반 MSA를 위한 Avro 스키마 및 이벤트 흐름 문서 관리 레포지토리

          ### 📝 이번 릴리스의 변경사항

          ${{ steps.schema_changes.outputs.changes }}

          ---

          ### 📊 포함된 내용

          - **Avro Schemas**: ${{ steps.count_schemas.outputs.count }} schemas
          - **Generated Java Classes**: ${{ steps.count_classes.outputs.count }} classes
          - **Event Flow Documentation**: SAGA pattern 이벤트 흐름 다이어그램

          ### 🚀 How to Use

          Add to your `build.gradle.kts`:

          ```kotlin
          repositories {
              maven {
                  url = uri("https://maven.pkg.github.com/GroomC4/c4ang-packages-hub")
                  credentials {
                      username = project.findProperty("gpr.user") as String? ?: System.getenv("GITHUB_ACTOR")
                      password = project.findProperty("gpr.key") as String? ?: System.getenv("GITHUB_TOKEN")
                  }
              }
          }

          dependencies {
              implementation("io.github.groomc4:c4ang-contract-hub:${{ steps.version.outputs.version }}")
          }
          ```

          ### 💻 Usage Example (Kotlin)

          ```kotlin
          // Producer
          import com.groom.ecommerce.order.event.avro.OrderCreated

          val event = OrderCreated.newBuilder()
              .setEventId(UUID.randomUUID().toString())
              .setOrderId("ORD-123")
              .setCustomerId("CUST-001")
              .build()

          kafkaTemplate.send("order.created", orderId, event)
          ```

          ### 📚 Key Features

          - ✅ **Avro Schema Management**: 도메인별 스키마 정의 (Order, Payment, Product, SAGA 등)
          - ✅ **Java Class Generation**: Avro → Java (Kotlin interop 지원)
          - ✅ **Event Flow Documentation**: 이벤트 시퀀스 다이어그램 및 명세
          - ✅ **GitHub Packages Distribution**: 안전한 패키지 배포

          ### 🔗 Links

          - [GitHub Packages](https://github.com/GroomC4/c4ang-packages-hub/packages)
          - [Documentation](https://github.com/GroomC4/c4ang-contract-hub#readme)
          - [Kafka Event Specifications](https://github.com/GroomC4/c4ang-contract-hub/blob/main/docs/interface/kafka-event-specifications.md)
          - [Event Sequence Diagrams](https://github.com/GroomC4/c4ang-contract-hub/blob/main/docs/interface/kafka-event-sequence.md)

          ### 📋 Documentation

          - [GitHub Packages Publishing Guide](docs/publishing/github-packages-publishing-guide.md)
          - [Avro Artifact Publishing](docs/publishing/avro-artifact-publishing.md)

          ---

          **Full Changelog**: https://github.com/GroomC4/c4ang-contract-hub/commits/${{ steps.version.outputs.tag }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            build/libs/*.jar
            docs/generated/*.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display package info
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo ""
          echo "✅ Release $VERSION completed!"
          echo ""
          echo "📦 Artifact is now available on GitHub Packages:"
          echo "    implementation(\"io.github.groomc4:c4ang-contract-hub:$VERSION\")"
          echo ""
          echo "🔗 GitHub Packages: https://github.com/GroomC4/c4ang-packages-hub/packages"
          echo "🔗 GitHub Release: https://github.com/GroomC4/c4ang-contract-hub/releases/tag/v$VERSION"

      - name: Display release summary
        if: success()
        run: |
          echo "::notice title=Release Complete::Version ${{ steps.version.outputs.version }} has been released successfully!"
          echo ""
          echo "📊 Release Summary:"
          echo "  - Version: ${{ steps.version.outputs.version }}"
          echo "  - Avro Schemas: ${{ steps.count_schemas.outputs.count }}"
          echo "  - Generated Classes: ${{ steps.count_classes.outputs.count }}"
          echo "  - Status: ✅ Success"
