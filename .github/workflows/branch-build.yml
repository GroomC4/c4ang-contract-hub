name: Branch Build

on:
  push:
    branches:
      - develop
      - 'feature/**'

jobs:
  build:
    name: Build and Validate Avro Schemas
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ï†ÑÏ≤¥ ÌûàÏä§ÌÜ†Î¶¨ (Ìò∏ÌôòÏÑ± Ï≤¥ÌÅ¨Ïö©)

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Count Avro schemas
        id: count_schemas
        run: |
          AVRO_COUNT=$(find src/main/avro -name "*.avsc" | wc -l)
          echo "count=$AVRO_COUNT" >> $GITHUB_OUTPUT
          echo "üìã Found $AVRO_COUNT Avro schema files"

      - name: Validate Avro schema syntax
        run: |
          echo "üîç Validating Avro schema syntax..."

          if [ ${{ steps.count_schemas.outputs.count }} -eq 0 ]; then
            echo "‚ùå No Avro schema files found!"
            exit 1
          fi

          # Í∞Å Ïä§ÌÇ§Îßà ÌååÏùºÏùò JSON Î¨∏Î≤ï Ï≤¥ÌÅ¨
          INVALID_COUNT=0
          for file in $(find src/main/avro -name "*.avsc"); do
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "‚ùå Invalid JSON in $file"
              INVALID_COUNT=$((INVALID_COUNT + 1))
            else
              echo "‚úÖ Valid: $file"
            fi
          done

          if [ $INVALID_COUNT -gt 0 ]; then
            echo "‚ùå Found $INVALID_COUNT invalid schema files"
            exit 1
          fi

          echo "‚úÖ All Avro schemas are syntactically valid"

      - name: Check for Breaking Changes
        id: breaking_changes
        continue-on-error: true
        run: |
          echo "üîç Checking for Breaking Changes in Avro schemas..."

          # Í∏∞Î≥∏ Î∏åÎûúÏπòÏôÄ ÎπÑÍµê (develop ÎòêÎäî main)
          BASE_BRANCH="develop"
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_BRANCH="main"
          fi

          # Î≥ÄÍ≤ΩÎêú Ïä§ÌÇ§Îßà ÌååÏùº Ï∞æÍ∏∞
          CHANGED_SCHEMAS=$(git diff --name-only origin/$BASE_BRANCH...HEAD -- 'src/main/avro/**/*.avsc' || echo "")

          if [ -z "$CHANGED_SCHEMAS" ]; then
            echo "‚ÑπÔ∏è No schema changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üìù Changed schemas:"
          echo "$CHANGED_SCHEMAS"
          echo ""

          # Breaking Change Ìå®ÌÑ¥ Ï≤¥ÌÅ¨
          BREAKING_FOUND=false
          for schema in $CHANGED_SCHEMAS; do
            if git diff origin/$BASE_BRANCH...HEAD -- "$schema" | grep -E '^\-.*"name".*:|^\-.*"type".*:' > /dev/null; then
              echo "‚ö†Ô∏è Potential breaking change in $schema (field removed or type changed)"
              BREAKING_FOUND=true
            fi
          done

          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "breaking_found=$BREAKING_FOUND" >> $GITHUB_OUTPUT

          if [ "$BREAKING_FOUND" = true ]; then
            echo ""
            echo "‚ö†Ô∏è WARNING: Potential breaking changes detected!"
            echo "Please review carefully and consider incrementing major version."
          fi

      - name: Generate Avro Java classes
        run: ./gradlew generateAvroJava --no-daemon

      - name: Verify generated classes
        run: |
          echo "üîç Verifying generated Java classes..."
          GENERATED_FILES=$(find build/generated-main-avro-java -name "*.java" | wc -l)
          echo "Generated $GENERATED_FILES Java class files"

          if [ $GENERATED_FILES -eq 0 ]; then
            echo "‚ùå No Java classes were generated!"
            exit 1
          fi

          echo "‚úÖ Java classes generated successfully"

      - name: Build project
        run: ./gradlew build --no-daemon

      - name: Generate Avro documentation
        run: ./gradlew generateAvroEventDocs --no-daemon

      - name: Sanitize branch name for artifact
        id: sanitize
        run: |
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/\//-/g')
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ steps.sanitize.outputs.branch_name }}
          path: |
            build/libs/*.jar
            build/generated-main-avro-java/
            docs/generated/*.md
          retention-days: 7

      - name: Display build summary
        if: success()
        run: |
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/\//-/g')
          JAR_FILE=$(ls build/libs/*.jar | head -n 1 | xargs basename)
          JAVA_FILES=$(find build/generated-main-avro-java -name "*.java" | wc -l)

          echo "‚úÖ Build successful!"
          echo ""
          echo "üìä Build Summary:"
          echo "  - Avro Schemas: ${{ steps.count_schemas.outputs.count }}"
          echo "  - Generated Java Classes: $JAVA_FILES"
          echo "  - JAR: $JAR_FILE"

          if [ "${{ steps.breaking_changes.outputs.breaking_found }}" = "true" ]; then
            echo ""
            echo "‚ö†Ô∏è WARNING: Potential breaking changes detected!"
            echo "Review the changes carefully before merging."
          fi

          echo ""
          echo "üì¶ This branch is now available on JitPack:"
          echo ""
          echo "    implementation(\"com.github.GroomC4:c4ang-contract-hub:${BRANCH_NAME}-SNAPSHOT\")"
          echo ""
          echo "üîó JitPack URL: https://jitpack.io/#GroomC4/c4ang-contract-hub/${BRANCH_NAME}-SNAPSHOT"
          echo ""
          echo "‚è±Ô∏è Note: First request to JitPack may take 1-3 minutes to build."
