name: PR Validation

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Fast PR Validation
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write  # PR ì½”ë©˜íŠ¸ ì‘ì„± ê¶Œí•œ

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # íƒ€ê²Ÿ ë¸Œëœì¹˜ ë¹„êµìš©

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check compatibility with target branch
        id: compatibility_check
        continue-on-error: true
        run: |
          echo "ğŸ” Checking compatibility with target branch: ${{ github.base_ref }}"

          # íƒ€ê²Ÿ ë¸Œëœì¹˜ì™€ ë¹„êµ
          TARGET_BRANCH="${{ github.base_ref }}"

          # ë³€ê²½ëœ ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì°¾ê¸°
          CHANGED_SCHEMAS=$(git diff --name-only origin/$TARGET_BRANCH...HEAD -- 'src/main/avro/**/*.avsc' || echo "")

          if [ -z "$CHANGED_SCHEMAS" ]; then
            echo "â„¹ï¸ No schema changes detected in this PR"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "breaking_found=false" >> $GITHUB_OUTPUT
            echo "changed_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          CHANGED_COUNT=$(echo "$CHANGED_SCHEMAS" | wc -l | tr -d ' ')
          echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT

          echo "ğŸ“ Changed schemas ($CHANGED_COUNT files):"
          echo "$CHANGED_SCHEMAS"
          echo ""

          # Breaking Change íŒ¨í„´ ì²´í¬
          BREAKING_FOUND=false
          BREAKING_FILES=""

          for schema in $CHANGED_SCHEMAS; do
            echo "Checking $schema..."
            DIFF_OUTPUT=$(git diff origin/$TARGET_BRANCH...HEAD -- "$schema")

            # í•„ë“œ ì‚­ì œ ë˜ëŠ” íƒ€ì… ë³€ê²½ ê°ì§€
            if echo "$DIFF_OUTPUT" | grep -E '^\-.*"name".*:|^\-.*"type".*:' > /dev/null; then
              echo "âš ï¸ Potential breaking change in $schema"
              BREAKING_FOUND=true
              BREAKING_FILES="$BREAKING_FILES\n- $schema"
            fi
          done

          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "breaking_found=$BREAKING_FOUND" >> $GITHUB_OUTPUT
          echo "breaking_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BREAKING_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$BREAKING_FOUND" = true ]; then
            echo ""
            echo "âš ï¸ WARNING: Potential breaking changes detected!"
            echo "Files with potential breaking changes:"
            echo -e "$BREAKING_FILES"
          fi

      - name: Quick build test
        run: |
          echo "ğŸ”¨ Running quick build test..."
          ./gradlew generateAvroJava build --no-daemon --parallel

      - name: Count generated classes
        id: count_classes
        run: |
          AVRO_COUNT=$(find src/main/avro -name "*.avsc" | wc -l)
          JAVA_COUNT=$(find build/generated-main-avro-java -name "*.java" 2>/dev/null | wc -l)

          echo "avro_count=$AVRO_COUNT" >> $GITHUB_OUTPUT
          echo "java_count=$JAVA_COUNT" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Schema Summary:"
          echo "  - Avro Schemas: $AVRO_COUNT"
          echo "  - Generated Java Classes: $JAVA_COUNT"

      - name: Upload generated artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ github.event.pull_request.number }}-artifacts
          path: |
            build/libs/*.jar
            docs/generated/*.md
          retention-days: 7

      - name: Comment PR with validation results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const hasChanges = '${{ steps.compatibility_check.outputs.has_changes }}' === 'true';
            const breakingFound = '${{ steps.compatibility_check.outputs.breaking_found }}' === 'true';
            const changedCount = '${{ steps.compatibility_check.outputs.changed_count }}';
            const breakingFiles = `${{ steps.compatibility_check.outputs.breaking_files }}`;
            const avroCount = '${{ steps.count_classes.outputs.avro_count }}';
            const javaCount = '${{ steps.count_classes.outputs.java_count }}';

            const status = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ';
            const statusText = '${{ job.status }}' === 'success' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';

            let changesSummary = '';
            if (hasChanges) {
              changesSummary = `
            ### ğŸ“ ìŠ¤í‚¤ë§ˆ ë³€ê²½ì‚¬í•­
            - **ë³€ê²½ëœ íŒŒì¼**: ${changedCount}ê°œ
            ${breakingFound ? `
            ### âš ï¸ Breaking Change ê°ì§€

            ë‹¤ìŒ íŒŒì¼ì—ì„œ ì ì¬ì ì¸ breaking changeê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:
            ${breakingFiles}

            **í•„ìš”í•œ ì¡°ì¹˜**:
            - ë³€ê²½ì‚¬í•­ì„ ì‹ ì¤‘í•˜ê²Œ ê²€í† í•´ì£¼ì„¸ìš”
            - Breaking changeì¸ ê²½ìš° **major ë²„ì „** ì¦ê°€ë¥¼ ê³ ë ¤í•˜ì„¸ìš”
            - ì˜í–¥ë°›ëŠ” Consumer ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”
            ` : '- âœ… Breaking changeê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'}
            `;
            } else {
              changesSummary = '\n### â„¹ï¸ ì´ PRì—ëŠ” ìŠ¤í‚¤ë§ˆ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤\n';
            }

            const comment = `## ${status} PR ê²€ì¦ - Avro ìŠ¤í‚¤ë§ˆ

            **ìƒíƒœ**: ${statusText}
            **íƒ€ê²Ÿ ë¸Œëœì¹˜**: \`${{ github.base_ref }}\`

            ### ğŸ“Š ìš”ì•½
            - **ì „ì²´ Avro ìŠ¤í‚¤ë§ˆ**: ${avroCount}ê°œ
            - **ìƒì„±ëœ Java í´ë˜ìŠ¤**: ${javaCount}ê°œ

            ${changesSummary}

            ### âœ… ê²€ì¦ í•­ëª©
            - ${hasChanges ? 'âœ…' : 'â„¹ï¸'} ìŠ¤í‚¤ë§ˆ í˜¸í™˜ì„± ì²´í¬
            - âœ… Java í´ë˜ìŠ¤ ìƒì„±
            - âœ… í”„ë¡œì íŠ¸ ë¹Œë“œ

            ---
            ğŸ’¡ **Tip**: \`./gradlew generateAvroJava\` ëª…ë ¹ìœ¼ë¡œ ë¡œì»¬ì—ì„œ ìƒì„±ëœ í´ë˜ìŠ¤ë¥¼ ë¯¸ë¦¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
